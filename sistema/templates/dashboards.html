{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboards - Attend Services</title>
    <link rel="stylesheet" href="{% static 'css/attend-style.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
     /* Reset b√°sico */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
    background: url('{% static "img/back 01.jpeg" %}?v=3') center center/cover no-repeat fixed;
    position: relative;
    margin: 0;
    padding: 0;
    min-height: 100vh;
    color: #e4e4e7;
}

body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(26, 26, 46, 0.85) 0%, rgba(22, 33, 62, 0.85) 100%);
    z-index: -1;
}

/* NAVBAR */
/* SIDEBAR */
.sidebar {
    position: fixed;
    left: 0;
    top: 0;
    width: 250px;
    height: 100vh;
    background: linear-gradient(180deg, #0f0f23 0%, #1a1a2e 100%);
    box-shadow: 4px 0 20px rgba(248, 194, 74, 0.15);
    border-right: 2px solid rgba(248, 194, 74, 0.2);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    padding: 20px 0;
}

.sidebar-logo {
    text-align: center;
    padding: 20px;
    border-bottom: 1px solid rgba(248, 194, 74, 0.2);
    margin-bottom: 30px;
}

.sidebar-logo img {
    height: 60px;
    width: auto;
    transition: transform 0.3s ease;
}

.sidebar-logo img:hover {
    transform: scale(1.05);
}

.sidebar-links {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 0 20px;
}

.sidebar a {
    color: #e4e4e7;
    text-decoration: none;
    font-weight: 600;
    font-size: 16px;
    padding: 15px 20px;
    border-radius: 12px;
    transition: all 0.3s ease;
    letter-spacing: 0.5px;
    position: relative;
    display: flex;
    align-items: center;
    gap: 12px;
}

.sidebar a::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    width: 4px;
    height: 100%;
    background: #F8C24A;
    border-radius: 0 4px 4px 0;
    transform: scaleY(0);
    transition: transform 0.3s ease;
}

.sidebar a:hover {
    color: #F8C24A;
    background: rgba(248, 194, 74, 0.1);
    transform: translateX(5px);
}

.sidebar a:hover::before {
    transform: scaleY(1);
}

.sidebar a.active {
    color: #F8C24A;
    background: rgba(248, 194, 74, 0.15);
}

.sidebar a.active::before {
    transform: scaleY(1);
}

/* MAIN CONTENT */
.main-content {
    margin-left: 250px;
    min-height: 100vh;
}

/* CONTAINER */
.container {
    max-width: 1600px;
    width: 100%;
    margin: 0 auto;
    padding: 20px 40px;
}

/* HEADER */
.header {
    text-align: center;
    margin-bottom: 40px;
}

.header h1 {
    font-size: 2.8rem;
    color: #F8C24A;
    margin-bottom: 15px;
    font-weight: 700;
    text-shadow: 0 2px 10px rgba(248, 194, 74, 0.3);
}

.quantity {
    font-size: 1.2rem;
    color: #a1a1aa;
    font-weight: 500;
}

.quantity strong {
    color: #F8C24A;
    font-weight: 700;
}

a{
    text-decoration: none;
}

/* ========== DASHBOARD STYLES ========== */
.dashboard-section {
    width: 100%;
    margin: 30px 0;
}

.dashboard-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.stat-card {
    background: linear-gradient(135deg, #1e1e30 0%, #252538 100%);
    padding: 30px;
    border-radius: 18px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    color: white;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(248, 194, 74, 0.15);
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, #F8C24A 0%, #f4a261 100%);
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.4s ease;
}

.stat-card::after {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(248, 194, 74, 0.1) 0%, transparent 70%);
    opacity: 0;
    transition: opacity 0.3s;
}

.stat-card:hover::before {
    transform: scaleX(1);
}

.stat-card:hover::after {
    opacity: 1;
}

.stat-card:hover {
    transform: translateY(-10px) scale(1.03);
    box-shadow: 0 20px 50px rgba(248, 194, 74, 0.3);
    border-color: rgba(248, 194, 74, 0.4);
}

.stat-icon {
    font-size: 3rem;
    margin-bottom: 15px;
    filter: drop-shadow(0 4px 8px rgba(248, 194, 74, 0.3));
}

.stat-value {
    font-size: 3rem;
    font-weight: 800;
    margin: 12px 0;
    background: linear-gradient(135deg, #F8C24A 0%, #ffd166 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.stat-label {
    font-size: 0.95rem;
    opacity: 0.85;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: #a1a1aa;
}

.chart-container {
    background: linear-gradient(135deg, #1e1e30 0%, #252538 100%);
    padding: 35px;
    border-radius: 18px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    margin-bottom: 30px;
    border: 1px solid rgba(248, 194, 74, 0.15);
    border-left: 4px solid #F8C24A;
    transition: all 0.3s ease;
}

.chart-container:hover {
    box-shadow: 0 15px 40px rgba(248, 194, 74, 0.2);
    border-left-width: 6px;
}

.chart-title {
    font-size: 1.6rem;
    color: #F8C24A;
    margin-bottom: 25px;
    font-weight: 700;
    text-align: center;
    letter-spacing: 0.5px;
    text-shadow: 0 2px 10px rgba(248, 194, 74, 0.2);
}

.charts-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 30px;
    margin-bottom: 40px;
}

.chart-wrapper {
    position: relative;
    height: 300px;
}

/* ========== PAINEL DE CONTROLE E FILTROS ========== */
.control-panel {
    background: linear-gradient(135deg, #1e1e30 0%, #252538 100%);
    padding: 20px 30px;
    border-radius: 18px;
    margin-bottom: 30px;
    border: 1px solid rgba(248, 194, 74, 0.15);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.control-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
}

.filter-section {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
}

.filter-label {
    color: #F8C24A;
    font-weight: 600;
    font-size: 1rem;
    white-space: nowrap;
}

.filter-buttons {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.filter-btn {
    padding: 8px 16px;
    border: 2px solid rgba(248, 194, 74, 0.3);
    background: rgba(30, 30, 48, 0.6);
    color: #e4e4e7;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    font-size: 13px;
    white-space: nowrap;
}

.filter-btn:hover {
    border-color: #F8C24A;
    background: rgba(248, 194, 74, 0.1);
    color: #F8C24A;
}

.filter-btn.active {
    background: linear-gradient(135deg, #F8C24A 0%, #f4a261 100%);
    color: #0f0f23;
    border-color: #F8C24A;
    box-shadow: 0 4px 15px rgba(248, 194, 74, 0.4);
}

.action-buttons {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items: center;
}

.export-btn, .config-btn, .cache-btn {
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 13px;
    white-space: nowrap;
}

.export-btn {
    background: linear-gradient(135deg, #F8C24A 0%, #f4a261 100%);
    color: #0f0f23;
    box-shadow: 0 4px 15px rgba(248, 194, 74, 0.3);
}

.export-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(248, 194, 74, 0.5);
}

.config-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.config-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
}

.cache-btn {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
}

.cache-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
}

/* ========== ALERTAS ========== */
#alertas-container {
    margin-bottom: 30px;
}

.alerta {
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 15px;
    animation: slideIn 0.5s ease;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.alerta.warning {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    border-left: 4px solid #fbbf24;
}

.alerta.danger {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    border-left: 4px solid #f87171;
}

.alerta.success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border-left: 4px solid #34d399;
}

.alerta-icon {
    font-size: 2rem;
}

.alerta-content {
    flex: 1;
    color: white;
}

.alerta-title {
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 5px;
}

.alerta-message {
    opacity: 0.95;
}

/* Modal de Configura√ß√£o */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(5px);
}

.modal-content {
    background: linear-gradient(135deg, #1e1e30 0%, #252538 100%);
    margin: 5% auto;
    padding: 30px;
    border: 1px solid rgba(248, 194, 74, 0.2);
    border-radius: 18px;
    width: 80%;
    max-width: 600px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

.modal-close {
    color: #F8C24A;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
}

.modal-close:hover {
    color: #ffd166;
    transform: scale(1.2);
}

.modal h2 {
    color: #F8C24A;
    margin-bottom: 20px;
}

.config-option {
    margin: 20px 0;
    padding: 15px;
    background: rgba(30, 30, 48, 0.6);
    border-radius: 10px;
    border: 1px solid rgba(248, 194, 74, 0.1);
}

.config-option label {
    color: #e4e4e7;
    font-weight: 600;
    display: block;
    margin-bottom: 8px;
}

.config-option input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

/* RESPONSIVIDADE */
@media (max-width: 768px) {
    .dashboard-section {
        padding: 0 15px;
    }
    
    .charts-grid {
        grid-template-columns: 1fr;
    }
    
    .stat-card {
        padding: 20px;
    }
    
    .stat-value {
        font-size: 2rem;
    }
    
    .control-row {
        flex-direction: column;
        align-items: stretch;
    }
    
    .filter-section {
        flex-direction: column;
        align-items: flex-start;
        width: 100%;
    }
    
    .filter-buttons {
        width: 100%;
        justify-content: flex-start;
    }
    
    .action-buttons {
        width: 100%;
        justify-content: flex-start;
    }
    
    .filter-btn, .export-btn, .config-btn, .cache-btn {
        flex: 0 0 auto;
    }
    
    .navbar {
        flex-wrap: wrap;
        padding: 15px 20px;
        justify-content: center;
    }
    
    .navbar-logo {
        height: 40px;
        margin-bottom: 10px;
    }
    
    .navbar-links {
        flex-direction: column;
        width: 100%;
        gap: 8px;
    }
    
    .navbar a {
        font-size: 14px;
        padding: 8px 16px;
        margin: 0;
    }
}

    </style>
</head>
<body>
    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="sidebar-logo">
            <img src="{% static 'img/logo.png' %}" alt="Attend Services">
        </div>
        
        <div class="sidebar-links">
            <a href="{% url 'nomes_analistas' %}">
                <span>üë•</span> Analistas
            </a>
            <a href="{% url 'cadastrar_chamado' %}">
                <span>‚ûï</span> Registrar Chamado
            </a>
            <a href="{% url 'views' %}">
                <span>üìã</span> Chamados de Hoje
            </a>
            <a href="{% url 'dashboards' %}" class="active">
                <span>üìä</span> Dashboards
            </a>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <div class="container">
        <div class="header">
            <h1>üìä Dashboards & Estat√≠sticas</h1>
            <div class="quantity">An√°lise completa de <strong>desempenho</strong> e <strong>produtividade</strong></div>
        </div>

        <!-- PAINEL DE CONTROLE E FILTROS -->
        <div class="control-panel">
            <div class="control-row">
                <div class="filter-section">
                    <span class="filter-label">‚öôÔ∏è Filtros:</span>
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="aplicarFiltro('hoje', this)">Hoje</button>
                        <button class="filter-btn" onclick="aplicarFiltro('semana', this)">Semana</button>
                        <button class="filter-btn" onclick="aplicarFiltro('mes', this)">M√™s</button>
                        <button class="filter-btn" onclick="aplicarFiltro('ano', this)">Ano</button>
                        <button class="filter-btn" onclick="aplicarFiltro('todos', this)">Todos</button>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="export-btn" onclick="exportarPDF()">
                        üìÑ PDF
                    </button>
                    <button class="config-btn" onclick="abrirConfigDashboard()">
                        üéõÔ∏è Config
                    </button>
                    <button class="cache-btn" onclick="limparCache()">
                        üîÑ Cache
                    </button>
                </div>
            </div>
        </div>

        <!-- ALERTAS DE M√âTRICAS -->
        <div id="alertas-container"></div>

        <!-- DASHBOARD SECTION -->
        <div class="dashboard-section">
            <!-- Cards de Estat√≠sticas -->
            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-value" id="total-chamados">0</div>
                    <div class="stat-label">Total de Chamados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚è±Ô∏è</div>
                    <div class="stat-value" id="tempo-medio">0</div>
                    <div class="stat-label">Tempo M√©dio</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-value" id="produtivas">0%</div>
                    <div class="stat-label">Produtividade</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-value" id="total-analistas">0</div>
                    <div class="stat-label">Analistas Ativos</div>
                </div>
            </div>

            <!-- Gr√°ficos -->
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">Distribui√ß√£o por Tipo de Atividade</div>
                    <div class="chart-wrapper">
                        <canvas id="tipoAtividadeChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Chamados por Analista</div>
                    <div class="chart-wrapper">
                        <canvas id="analistaChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">Tempo de Atendimento por Chamado</div>
                    <div class="chart-wrapper">
                        <canvas id="tempoChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">‚è±Ô∏è Tempo M√©dio por M√™s</div>
                    <div class="chart-wrapper">
                        <canvas id="tempoMedioPorMesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Configura√ß√£o -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="fecharConfigDashboard()">&times;</span>
            <h2>üéõÔ∏è Personalizar Dashboard</h2>
            
            <div class="config-option">
                <label>
                    <input type="checkbox" id="mostrarGraficoTipos" checked> 
                    Mostrar Gr√°fico de Tipos de Atividade
                </label>
            </div>
            
            <div class="config-option">
                <label>
                    <input type="checkbox" id="mostrarGraficoAnalistas" checked> 
                    Mostrar Gr√°fico de Analistas
                </label>
            </div>
            
            <div class="config-option">
                <label>
                    <input type="checkbox" id="mostrarGraficoTempo" checked> 
                    Mostrar Gr√°fico de Tempo
                </label>
            </div>
            
            <div class="config-option">
                <label>
                    <input type="checkbox" id="mostrarGraficoTempoMes" checked> 
                    Mostrar Gr√°fico de Tempo M√©dio por M√™s
                </label>
            </div>
            
            <div class="config-option">
                <label>
                    <input type="checkbox" id="mostrarAlertas" checked> 
                    Mostrar Alertas de M√©tricas
                </label>
            </div>
            
            <div class="config-option">
                <label>
                    Meta de Produtividade (%):
                    <input type="number" id="metaProdutividade" value="80" min="0" max="100" 
                           style="width: 100px; margin-left: 10px; color: #e4e4e7;">
                </label>
            </div>
            
            <button class="export-btn" onclick="salvarConfiguracao()" style="width: 100%; margin-top: 20px;">
                üíæ Salvar Configura√ß√µes
            </button>
        </div>
    </div>

    <script type="application/json" id="chamados-data">
        [{% for chamado in chamados %}{"analista": "{{ chamado.nome_analista }}", "tipo": "{{ chamado.tipo_atividade }}", "tempo": "{{ chamado.total_horas }}", "produtiva": {% if chamado.produtiva %}true{% else %}false{% endif %}, "tecnico": "{{ chamado.nome_tecnico }}", "data": "{{ chamado.data }}"} {% if not forloop.last %},{% endif %}{% endfor %}]
    </script>

    <script>
        // ==================== CACHE E CONFIGURA√á√ïES ====================
        const CACHE_KEY = 'dashboard_cache';
        const CONFIG_KEY = 'dashboard_config';
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutos

        // Carregar configura√ß√µes salvas
        function carregarConfiguracoes() {
            const config = localStorage.getItem(CONFIG_KEY);
            if (config) {
                return JSON.parse(config);
            }
            return {
                mostrarGraficoTipos: true,
                mostrarGraficoAnalistas: true,
                mostrarGraficoTempo: true,
                mostrarGraficoTempoMes: true,
                mostrarAlertas: true,
                metaProdutividade: 80
            };
        }

        function salvarConfiguracao() {
            const config = {
                mostrarGraficoTipos: document.getElementById('mostrarGraficoTipos').checked,
                mostrarGraficoAnalistas: document.getElementById('mostrarGraficoAnalistas').checked,
                mostrarGraficoTempo: document.getElementById('mostrarGraficoTempo').checked,
                mostrarGraficoTempoMes: document.getElementById('mostrarGraficoTempoMes').checked,
                mostrarAlertas: document.getElementById('mostrarAlertas').checked,
                metaProdutividade: parseInt(document.getElementById('metaProdutividade').value)
            };

            localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
            fecharConfigDashboard();
            alert('‚úÖ Configura√ß√µes salvas! Recarregando p√°gina...');
            location.reload();
        }

        function abrirConfigDashboard() {
            const config = carregarConfiguracoes();
            document.getElementById('mostrarGraficoTipos').checked = config.mostrarGraficoTipos;
            document.getElementById('mostrarGraficoAnalistas').checked = config.mostrarGraficoAnalistas;
            document.getElementById('mostrarGraficoTempo').checked = config.mostrarGraficoTempo;
            document.getElementById('mostrarGraficoTempoMes').checked = config.mostrarGraficoTempoMes;
            document.getElementById('mostrarAlertas').checked = config.mostrarAlertas;
            document.getElementById('metaProdutividade').value = config.metaProdutividade;

            document.getElementById('configModal').style.display = 'block';
        }

        function fecharConfigDashboard() {
            document.getElementById('configModal').style.display = 'none';
        }

        function limparCache() {
            localStorage.removeItem(CACHE_KEY);
            alert('üîÑ Cache limpo com sucesso!');
            location.reload();
        }

        // ==================== EXPORTAR PDF ====================
        function exportarPDF() {
            window.location.href = '/exportar-pdf/';
        }

        // ==================== FILTROS POR PER√çODO ====================
        let chamadosOriginais = [];
        let filtroAtual = 'todos';

        function aplicarFiltro(periodo, btn) {
            filtroAtual = periodo;

            // Atualizar bot√µes ativos
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            btn.classList.add('active');

            const hoje = new Date();
            let dataLimite;

            switch(periodo) {
                case 'semana':
                    dataLimite = new Date(hoje.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'mes':
                    dataLimite = new Date(hoje.getTime() - 30 * 24 * 60 * 60 * 1000);
                    break;
                case 'ano':
                    dataLimite = new Date(hoje.getTime() - 365 * 24 * 60 * 60 * 1000);
                    break;
                case 'todos':
                    dataLimite = null;
                    break;
                default: // hoje
                    dataLimite = hoje;
                    dataLimite.setHours(0, 0, 0, 0);
            }

            // Filtrar chamados
            let chamadosFiltrados;
            if (!dataLimite || periodo === 'todos') {
                chamadosFiltrados = chamadosOriginais;
            } else {
                chamadosFiltrados = chamadosOriginais.filter(chamado => {
                    const dataChamado = new Date(chamado.data);
                    return dataChamado >= dataLimite;
                });
            }

            // Atualizar visualiza√ß√£o
            atualizarDashboard(chamadosFiltrados);
        }

        function atualizarDashboard(chamadosFiltrados) {
            // Recalcular estat√≠sticas
            calcularEstatisticas(chamadosFiltrados);

            // Recriar gr√°ficos
            window.chartTipos?.destroy();
            window.chartAnalistas?.destroy();
            window.chartTempo?.destroy();
            window.chartTempoMes?.destroy();

            criarGraficoTipoAtividade(chamadosFiltrados);
            criarGraficoAnalistas(chamadosFiltrados);
            criarGraficoTempo(chamadosFiltrados);
            criarGraficoTempoMedioPorMes(chamadosFiltrados);

            // Verificar alertas
            verificarAlertas(chamadosFiltrados);
        }

        // ==================== ALERTAS DE M√âTRICAS ====================
        function verificarAlertas(chamadosList) {
            const config = carregarConfiguracoes();
            if (!config.mostrarAlertas) return;

            const container = document.getElementById('alertas-container');
            container.innerHTML = '';

            const totalChamados = chamadosList.length;
            if (totalChamados === 0) return;

            const produtivas = chamadosList.filter(c => c.produtiva).length;
            const produtividade = Math.round((produtivas / totalChamados) * 100);

            // Alerta de produtividade baixa
            if (produtividade < config.metaProdutividade) {
                const alerta = document.createElement('div');
                alerta.className = 'alerta danger';
                alerta.innerHTML = `
                    <div class="alerta-icon">‚ö†Ô∏è</div>
                    <div class="alerta-content">
                        <div class="alerta-title">Produtividade Abaixo da Meta</div>
                        <div class="alerta-message">
                            Produtividade atual: ${produtividade}% | Meta: ${config.metaProdutividade}%
                        </div>
                    </div>
                `;
                container.appendChild(alerta);
            }

            // Alerta de poucos chamados
            if (totalChamados < 5 && filtroAtual === 'hoje') {
                const alerta = document.createElement('div');
                alerta.className = 'alerta warning';
                alerta.innerHTML = `
                    <div class="alerta-icon">üìâ</div>
                    <div class="alerta-content">
                        <div class="alerta-title">Baixo Volume de Chamados</div>
                        <div class="alerta-message">
                            Apenas ${totalChamados} chamados registrados hoje
                        </div>
                    </div>
                `;
                container.appendChild(alerta);
            }

            // Alerta de sucesso
            if (produtividade >= config.metaProdutividade && totalChamados > 10) {
                const alerta = document.createElement('div');
                alerta.className = 'alerta success';
                alerta.innerHTML = `
                    <div class="alerta-icon">‚úÖ</div>
                    <div class="alerta-content">
                        <div class="alerta-title">Excelente Desempenho!</div>
                        <div class="alerta-message">
                            Produtividade de ${produtividade}% com ${totalChamados} chamados
                        </div>
                    </div>
                `;
                container.appendChild(alerta);
            }
        }

        // Coletar dados dos chamados do Django
        const chamados = JSON.parse(document.getElementById('chamados-data').textContent);

        // Armazenar chamados originais
        chamadosOriginais = chamados;

        // Processar dados para estat√≠sticas
        function calcularEstatisticas(chamadosList = chamados) {
            const totalChamados = chamadosList.length;
            document.getElementById('total-chamados').textContent = totalChamados;

            // Calcular tempo m√©dio
            let totalMinutos = 0;
            chamadosList.forEach(chamado => {
                const tempo = chamado.tempo;
                const partes = tempo.split(':');
                const horas = parseInt(partes[0]) || 0;
                const minutos = parseInt(partes[1]) || 0;
                totalMinutos += (horas * 60) + minutos;
            });
            
            const mediaMinutos = totalChamados > 0 ? Math.round(totalMinutos / totalChamados) : 0;
            const mediaHoras = Math.floor(mediaMinutos / 60);
            const mediaMin = mediaMinutos % 60;
            document.getElementById('tempo-medio').textContent = 
                `${mediaHoras}h ${mediaMin}m`;

            // Calcular produtividade
            const produtivas = chamadosList.filter(c => c.produtiva).length;
            const percProdutividade = totalChamados > 0 
                ? Math.round((produtivas / totalChamados) * 100) 
                : 0;
            document.getElementById('produtivas').textContent = `${percProdutividade}%`;

            // Contar analistas √∫nicos
            const analistas = new Set(chamadosList.map(c => c.analista));
            document.getElementById('total-analistas').textContent = analistas.size;
        }

        // Criar gr√°fico de tipo de atividade
        function criarGraficoTipoAtividade(chamadosList = chamados) {
            const config = carregarConfiguracoes();
            if (!config.mostrarGraficoTipos) {
                document.getElementById('tipoAtividadeChart').closest('.chart-container').style.display = 'none';
                return;
            }
            
            const tipos = {};
            chamadosList.forEach(chamado => {
                tipos[chamado.tipo] = (tipos[chamado.tipo] || 0) + 1;
            });

            const ctx = document.getElementById('tipoAtividadeChart').getContext('2d');
            window.chartTipos = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(tipos),
                    datasets: [{
                        data: Object.values(tipos),
                        backgroundColor: [
                            '#F8C24A',
                            '#f4a261',
                            '#ffd166',
                            '#e07a5f',
                            '#f2cc8f',
                            '#F8C24A'
                        ],
                        borderWidth: 3,
                        borderColor: '#1e1e30'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                color: '#e4e4e7',
                                font: {
                                    size: 12,
                                    family: "'Inter', sans-serif"
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(30, 30, 48, 0.95)',
                            titleColor: '#F8C24A',
                            bodyColor: '#e4e4e7',
                            borderColor: '#F8C24A',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Criar gr√°fico de analistas
        function criarGraficoAnalistas(chamadosList = chamados) {
            const config = carregarConfiguracoes();
            if (!config.mostrarGraficoAnalistas) {
                document.getElementById('analistaChart').closest('.chart-container').style.display = 'none';
                return;
            }
            
            const analistas = {};
            chamadosList.forEach(chamado => {
                const nome = chamado.analista.replace(/_/g, ' ');
                analistas[nome] = (analistas[nome] || 0) + 1;
            });

            const ctx = document.getElementById('analistaChart').getContext('2d');
            window.chartAnalistas = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(analistas),
                    datasets: [{
                        label: 'Chamados',
                        data: Object.values(analistas),
                        backgroundColor: 'rgba(248, 194, 74, 0.8)',
                        borderColor: '#F8C24A',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                color: '#a1a1aa',
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                color: 'rgba(248, 194, 74, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#e4e4e7',
                                font: {
                                    size: 11
                                },
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(30, 30, 48, 0.95)',
                            titleColor: '#F8C24A',
                            bodyColor: '#e4e4e7',
                            borderColor: '#F8C24A',
                            borderWidth: 1,
                            padding: 12
                        }
                    }
                }
            });
        }

        // Criar gr√°fico de tempo
        function criarGraficoTempo(chamadosList = chamados) {
            const config = carregarConfiguracoes();
            if (!config.mostrarGraficoTempo) {
                document.getElementById('tempoChart').closest('.chart-container').style.display = 'none';
                return;
            }
            
            const temposEmMinutos = chamadosList.map((chamado, index) => {
                const tempo = chamado.tempo;
                const partes = tempo.split(':');
                const horas = parseInt(partes[0]) || 0;
                const minutos = parseInt(partes[1]) || 0;
                return (horas * 60) + minutos;
            });

            const labels = chamadosList.map((_, index) => `#${index + 1}`);

            const ctx = document.getElementById('tempoChart').getContext('2d');
            window.chartTempo = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tempo (minutos)',
                        data: temposEmMinutos,
                        borderColor: '#F8C24A',
                        backgroundColor: 'rgba(248, 194, 74, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointBackgroundColor: '#F8C24A',
                        pointBorderColor: '#1e1e30',
                        pointBorderWidth: 2,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    const horas = Math.floor(value / 60);
                                    const mins = value % 60;
                                    return horas > 0 ? `${horas}h ${mins}m` : `${mins}m`;
                                },
                                color: '#a1a1aa',
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                color: 'rgba(248, 194, 74, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#e4e4e7',
                                font: {
                                    size: 10
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(30, 30, 48, 0.95)',
                            titleColor: '#F8C24A',
                            bodyColor: '#e4e4e7',
                            borderColor: '#F8C24A',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const minutos = context.parsed.y;
                                    const horas = Math.floor(minutos / 60);
                                    const mins = minutos % 60;
                                    return `Tempo: ${horas}h ${mins}m`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ==================== GR√ÅFICO DE TEMPO M√âDIO POR M√äS ====================
        function criarGraficoTempoMedioPorMes(chamadosList = chamados) {
            const config = carregarConfiguracoes();
            if (!config.mostrarGraficoTempoMes) {
                document.getElementById('tempoMedioPorMesChart').closest('.chart-container').style.display = 'none';
                return;
            }
            
            // Agrupar chamados por m√™s e calcular tempo m√©dio
            const dadosPorMes = {};
            
            chamadosList.forEach(chamado => {
                const data = new Date(chamado.data);
                const mesAno = `${data.toLocaleString('pt-BR', { month: 'short' })}/${data.getFullYear()}`;
                
                if (!dadosPorMes[mesAno]) {
                    dadosPorMes[mesAno] = {
                        totalMinutos: 0,
                        quantidade: 0,
                        data: data
                    };
                }
                
                const tempo = chamado.tempo;
                const partes = tempo.split(':');
                const horas = parseInt(partes[0]) || 0;
                const minutos = parseInt(partes[1]) || 0;
                const totalMinutos = (horas * 60) + minutos;
                
                dadosPorMes[mesAno].totalMinutos += totalMinutos;
                dadosPorMes[mesAno].quantidade++;
            });
            
            // Ordenar por data
            const mesesOrdenados = Object.entries(dadosPorMes)
                .sort((a, b) => a[1].data - b[1].data)
                .slice(-12); // √öltimos 12 meses
            
            const labels = mesesOrdenados.map(([mes]) => mes);
            const mediasMinutos = mesesOrdenados.map(([_, dados]) => 
                Math.round(dados.totalMinutos / dados.quantidade)
            );
            
            const ctx = document.getElementById('tempoMedioPorMesChart').getContext('2d');
            window.chartTempoMes = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tempo M√©dio (minutos)',
                        data: mediasMinutos,
                        backgroundColor: createGradient(ctx),
                        borderColor: '#F8C24A',
                        borderWidth: 2,
                        borderRadius: 10,
                        hoverBackgroundColor: '#ffd166',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    const h = Math.floor(value / 60);
                                    const m = value % 60;
                                    return h > 0 ? `${h}h ${m}m` : `${m}m`;
                                },
                                color: '#a1a1aa',
                                font: {
                                    size: 11,
                                    family: "'Inter', sans-serif"
                                }
                            },
                            grid: {
                                color: 'rgba(248, 194, 74, 0.1)',
                                drawBorder: false
                            }
                        },
                        x: {
                            ticks: {
                                color: '#e4e4e7',
                                font: {
                                    size: 11,
                                    family: "'Inter', sans-serif"
                                },
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(30, 30, 48, 0.95)',
                            titleColor: '#F8C24A',
                            bodyColor: '#e4e4e7',
                            borderColor: '#F8C24A',
                            borderWidth: 1,
                            padding: 15,
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                title: function(context) {
                                    return `üìÖ ${context[0].label}`;
                                },
                                label: function(context) {
                                    const minutos = context.parsed.y;
                                    const h = Math.floor(minutos / 60);
                                    const m = minutos % 60;
                                    return `‚è±Ô∏è Tempo m√©dio: ${h}h ${m}m`;
                                },
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    const dados = mesesOrdenados[index][1];
                                    return `üìä Total de chamados: ${dados.quantidade}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Fun√ß√£o auxiliar para criar gradiente
        function createGradient(ctx) {
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(248, 194, 74, 0.9)');
            gradient.addColorStop(0.5, 'rgba(244, 162, 97, 0.7)');
            gradient.addColorStop(1, 'rgba(248, 194, 74, 0.5)');
            return gradient;
        }

        // Inicializar tudo quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function() {
            calcularEstatisticas();
            criarGraficoTipoAtividade();
            criarGraficoAnalistas();
            criarGraficoTempo();
            criarGraficoTempoMedioPorMes();
            verificarAlertas(chamados);
        });
    </script>
        </div>
    </div>
    
</body>
</html>

