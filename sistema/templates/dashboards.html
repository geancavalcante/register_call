{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboards - Attend Services</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, rgba(10, 10, 10, 0.8) 0%, rgba(26, 26, 26, 0.8) 100%), url('{% static "img/back 01.jpeg" %}');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* SIDEBAR */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%);
            border-right: 2px solid rgba(248, 194, 74, 0.2);
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .logo {
            padding: 30px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(248, 194, 74, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .logo img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            border-radius: 50%;
            background: transparent;
        }

        nav {
            flex: 1;
            padding: 20px 0;
        }

        nav a {
            display: block;
            padding: 15px 25px;
            color: #ccc;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        nav a:hover {
            color: #F8C24A;
            background: rgba(248, 194, 74, 0.1);
            border-left-color: #F8C24A;
        }

        nav a.active {
            color: #F8C24A;
            background: rgba(248, 194, 74, 0.15);
            border-left-color: #F8C24A;
            font-weight: 600;
        }

        /* MAIN CONTENT */
        .main-content {
            margin-left: 260px;
            padding: 30px 40px;
            min-height: 100vh;
        }

        /* HEADER */
        .page-header {
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(248, 194, 74, 0.2);
        }

        .page-header h1 {
            font-size: 42px;
            font-weight: 800;
            color: #F8C24A;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .page-header p {
            color: #999;
            font-size: 18px;
        }

        /* STATS CARDS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1f1f1f 0%, #141414 100%);
            border: 1px solid rgba(248, 194, 74, 0.2);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(248, 194, 74, 0.1);
            border-color: rgba(248, 194, 74, 0.4);
        }

        .stat-card.clickable:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(248, 194, 74, 0.2);
            border-color: rgba(248, 194, 74, 0.6);
            background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
        }

        .stat-label {
            color: #999;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 800;
            color: #F8C24A;
            margin-bottom: 8px;
        }

        .stat-desc {
            color: #666;
            font-size: 12px;
        }

        /* CHARTS */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 30px;
            height: 800px;
        }


        .chart-container {
            background: linear-gradient(135deg, #1f1f1f 0%, #141414 100%);
            border: 1px solid rgba(248, 194, 74, 0.2);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
        }

        .chart-container:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(248, 194, 74, 0.1);
        }

        .chart-container h3 {
            color: #F8C24A;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chart-wrapper {
            position: relative;
            height: 280px;
        }

        /* FILTROS */
        .filters-section {
            background: linear-gradient(135deg, #1f1f1f 0%, #141414 100%);
            border: 1px solid rgba(248, 194, 74, 0.2);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr auto;
            gap: 20px;
            align-items: start;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            color: #F8C24A;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .filter-select, .filter-date {
            background: #2a2a2a;
            border: 1px solid rgba(248, 194, 74, 0.3);
            border-radius: 8px;
            padding: 10px 12px;
            color: #fff;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .filter-select:focus, .filter-date:focus {
            outline: none;
            border-color: #F8C24A;
            box-shadow: 0 0 10px rgba(248, 194, 74, 0.2);
        }


        .date-range {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 160px;
        }

        .filter-btn {
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            width: 100%;
            text-align: center;
            white-space: nowrap;
        }

        .filter-btn.primary {
            background: linear-gradient(135deg, #F8C24A 0%, #C69A3A 100%);
            color: #0a0a0a;
        }

        .filter-btn.secondary {
            background: #2a2a2a;
            color: #F8C24A;
            border: 1px solid #F8C24A;
        }

        .filter-btn.tertiary {
            background: #1a4d80;
            color: #fff;
            border: 1px solid #2a6db0;
        }

        .filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* TOAST NOTIFICATIONS */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 15px;
            pointer-events: none;
        }

        .toast {
            min-width: 300px;
            max-width: 380px;
            padding: 16px 20px;
            border-radius: 8px;
            background: linear-gradient(135deg, #1f1f1f 0%, #141414 100%);
            border: 1px solid rgba(248, 194, 74, 0.2);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            gap: 12px;
            pointer-events: all;
            cursor: pointer;
            animation: slideInRight 0.3s ease-out;
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .toast.hiding {
            animation: slideOutRight 0.3s ease-in forwards;
        }

        .toast-icon {
            font-size: 20px;
            line-height: 1;
            flex-shrink: 0;
            opacity: 0.9;
        }

        .toast-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .toast-title {
            font-size: 14px;
            font-weight: 600;
            line-height: 1.3;
            margin: 0;
            color: #F8C24A;
        }

        .toast-message {
            font-size: 13px;
            line-height: 1.4;
            color: #ccc;
            margin: 0;
        }

        .toast-close {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #999;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            opacity: 0;
        }

        .toast:hover .toast-close {
            opacity: 1;
        }

        .toast-close:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #F8C24A;
            transform: scale(1.1);
        }


        /* Toast Types - Dark Theme */
        .toast.warning {
            border-left: 3px solid #ffa500;
        }

        .toast.warning .toast-icon {
            color: #ffa500;
        }

        .toast.danger {
            border-left: 3px solid #ff4444;
        }

        .toast.danger .toast-icon {
            color: #ff4444;
        }

        .toast.info {
            border-left: 3px solid #4ade80;
        }

        .toast.info .toast-icon {
            color: #4ade80;
        }

        .toast.success {
            border-left: 3px solid #F8C24A;
        }

        .toast.success .toast-icon {
            color: #F8C24A;
        }

        /* RESPONSIVE */
        @media (max-width: 1200px) {
            .filters-grid {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto auto auto;
                gap: 15px;
            }
            
            .filter-actions {
                grid-column: 1 / -1;
                flex-direction: row;
                width: 100%;
                justify-content: center;
            }
            
            .filter-btn {
                width: auto;
                flex: 1;
                max-width: 200px;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
                grid-template-rows: repeat(4, 1fr);
                height: auto;
            }
        }

        @media (max-width: 768px) {
            .filters-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .filter-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .filter-btn {
                width: 100%;
                max-width: none;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 0;
                overflow: hidden;
            }

            .main-content {
                margin-left: 0;
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .page-header h1 {
                font-size: 28px;
            }

            .toast-container {
                top: 10px;
                right: 10px;
                left: 10px;
            }

            .toast {
                min-width: auto;
                width: 100%;
                padding: 14px 16px;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- TOAST CONTAINER -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="logo">
            <img src="{% static 'img/logo.png' %}" alt="Attend Services Logo">
        </div>
        <nav>
            <a href="{% url 'dashboards' %}" class="active">Dashboards</a>
            <a href="{% url 'nomes_analistas' %}">Analistas</a>
            <a href="{% url 'cadastrar_chamado' %}">Registrar Chamado</a>
            <a href="{% url 'todos_chamados' %}">Todos os Chamados</a>
        </nav>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <!-- HEADER -->
        <div class="page-header">
            <h1>Dashboards Analíticos</h1>
            <p>Visão geral do desempenho e estatísticas dos chamados</p>
        </div>

        <!-- FILTROS -->
        <div class="filters-section">
            <h2 style="color: #F8C24A; margin-bottom: 20px; font-size: 24px;">🎯 Filtros e Períodos</h2>
            
            <div class="filters-grid">
                <!-- Filtro de Período -->
                <div class="filter-group">
                    <label class="filter-label">📅 Período</label>
                    <select id="periodFilter" class="filter-select">
                        <option value="0">Hoje</option>
                        <option value="7">Últimos 7 dias</option>
                        <option value="30" selected>Últimos 30 dias</option>
                        <option value="90">Últimos 3 meses</option>
                        <option value="custom">Período personalizado</option>
                    </select>
                </div>

                <!-- Date Picker Personalizado -->
                <div class="filter-group" id="customDateGroup" style="display: none;">
                    <label class="filter-label">🗓️ Período Personalizado</label>
                    <div class="date-range">
                        <input type="date" id="startDate" class="filter-date">
                        <span style="color: #F8C24A; margin: 0 10px;">até</span>
                        <input type="date" id="endDate" class="filter-date">
                    </div>
                </div>

                <!-- Filtro de Analistas -->
                <div class="filter-group">
                    <label class="filter-label">👥 Analistas</label>
                    <select id="analystFilter" class="filter-select">
                        <option value="all" selected>Todos os analistas</option>
                        <option value="Paulo_Henrique">Paulo Henrique</option>
                        <option value="Joao_Cezar">João Cezar</option>
                        <option value="Ramon_Farias">Ramon Farias</option>
                        <option value="Pedro_Alexandre">Pedro Alexandre</option>
                        <option value="Adryson_Costa">Adryson Costa</option>
                        <option value="Mateus_Bezerra">Mateus Bezerra</option>
                        <option value="Guilherme_Palmiere">Guilherme Palmiere</option>
                        <option value="Miguel_Campos">Miguel Campos</option>
                        <option value="Gean_Cavalcante">Gean Cavalcante</option>
                    </select>
                </div>

                <!-- Filtro de Tipo de Atividade -->
                <div class="filter-group">
                    <label class="filter-label">📋 Tipo de Atividade</label>
                    <select id="activityFilter" class="filter-select">
                        <option value="all" selected>Todos os tipos</option>
                        <option value="Migração">Migração</option>
                        <option value="Suporte">Suporte</option>
                        <option value="Manutenção">Manutenção</option>
                        <option value="Desenvolvimento">Desenvolvimento</option>
                    </select>
                </div>

                <!-- Filtro de Produtividade -->
                <div class="filter-group">
                    <label class="filter-label">✅ Produtividade</label>
                    <select id="productivityFilter" class="filter-select">
                        <option value="all" selected>Todos</option>
                        <option value="true">Só produtivos</option>
                        <option value="false">Só não-produtivos</option>
                    </select>
                </div>

                <!-- Botões de Ação -->
                <div class="filter-actions">
                    <button id="applyFilters" class="filter-btn primary">🔍 Forçar Aplicar</button>
                    <button id="clearFilters" class="filter-btn secondary">🔄 Limpar Filtros</button>
                </div>
            </div>
        </div>

        <!-- STATS CARDS -->
        <div class="stats-grid">
            <div class="stat-card clickable" id="totalChamadosCard" style="cursor: pointer;" title="Clique para ver todos os chamados com os filtros aplicados">
                <div class="stat-label">Total de Chamados</div>
                <div class="stat-value" id="totalChamados">0</div>
                <div class="stat-desc">Registrados no sistema</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Tempo Médio</div>
                <div class="stat-value" id="tempoMedio">0h 0m</div>
                <div class="stat-desc">Por chamado</div>
            </div>
            <div class="stat-card clickable" id="taxaProdutividadeCard" style="cursor: pointer;" title="Clique para ver todos os chamados produtivos">
                <div class="stat-label">Taxa de Produtividade</div>
                <div class="stat-value" id="taxaProdutividade">0%</div>
                <div class="stat-desc">Chamados produtivos</div>
            </div>
        </div>

        <!-- CHARTS -->
        <div class="charts-grid">
            <!-- GRÁFICO 1: Distribuição por Tipo de Atividade -->
            <div class="chart-container">
                <h3>📊 Distribuição por Tipo de Atividade</h3>
                <div class="chart-wrapper">
                    <canvas id="chartTipoAtividade"></canvas>
                </div>
            </div>

            <!-- GRÁFICO 2: Chamados por Analista -->
            <div class="chart-container">
                <h3>👥 Chamados por Analista</h3>
                <div class="chart-wrapper">
                    <canvas id="chartAnalista"></canvas>
                </div>
            </div>

            <!-- GRÁFICO 3: Tempo Médio por Mês -->
            <div class="chart-container">
                <h3>📅 Tempo Médio por Mês</h3>
                <div class="chart-wrapper">
                    <canvas id="chartTempoMes"></canvas>
                </div>
            </div>

            <!-- GRÁFICO 4: Tempo Médio por Analista -->
            <div class="chart-container">
                <h3>⏱️ Tempo Médio por Analista</h3>
                <div class="chart-wrapper">
                    <canvas id="chartTempoAnalista"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('🚀 DASHBOARD INICIANDO...');
        
        // Plugin simples para mostrar valores
        const showValuesPlugin = {
            id: 'showValues',
            afterDatasetsDraw: function(chart) {
                const ctx = chart.ctx;
                chart.data.datasets.forEach((dataset, datasetIndex) => {
                    const meta = chart.getDatasetMeta(datasetIndex);
                    meta.data.forEach((element, index) => {
                        const data = dataset.data[index];
                        if (data && data > 0) {
                            ctx.save();
                            
                            ctx.font = 'bold 12px Inter, sans-serif';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            
                            let text = data.toString();
                            let x, y;
                            
                            if (chart.config.type === 'bar') {
                                x = element.x;
                                y = element.y - 20;
                                ctx.fillStyle = '#F8C24A';
                            } else if (chart.config.type === 'line') {
                                x = element.x;
                                y = element.y - 25;
                                ctx.fillStyle = '#F8C24A';
                            } else if (chart.config.type === 'doughnut') {
                                const centerX = element.x;
                                const centerY = element.y;
                                const angle = element.startAngle + (element.endAngle - element.startAngle) / 2;
                                const radius = element.outerRadius + 15; // Mais perto da rosca
                                x = centerX + Math.cos(angle) * radius;
                                y = centerY + Math.sin(angle) * radius;
                                
                                const total = dataset.data.reduce((a, b) => a + b, 0);
                                const percent = ((data / total) * 100).toFixed(1);
                                text = `${data} (${percent}%)`;
                                
                                // Desenhar fundo primeiro
                                ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                                ctx.strokeStyle = '#F8C24A';
                                ctx.lineWidth = 1;
                                
                                const textMetrics = ctx.measureText(text);
                                const textWidth = textMetrics.width;
                                const textHeight = 16;
                                const padding = 6;
                                
                                const rectX = x - (textWidth / 2) - padding;
                                const rectY = y - (textHeight / 2) - padding;
                                const rectWidth = textWidth + (padding * 2);
                                const rectHeight = textHeight + (padding * 2);
                                
                                // Fundo com bordas arredondadas
                                ctx.fillRect(rectX, rectY, rectWidth, rectHeight);
                                ctx.strokeRect(rectX, rectY, rectWidth, rectHeight);
                                
                                // Cor do texto
                                ctx.fillStyle = '#F8C24A';
                            }
                            
                            // Formatação especial para tempo
                            if (chart.canvas.id === 'chartTempoAnalista' || chart.canvas.id === 'chartTempoMes') {
                                text = formatTime(data);
                            }
                            
                            ctx.fillText(text, x, y);
                            ctx.restore();
                        }
                    });
                });
            }
        };
        
        Chart.register(showValuesPlugin);
        
        // Variáveis globais para filtros
        let filteredChamados = [];
        let currentFilters = {
            period: 30,
            startDate: null,
            endDate: null,
            analysts: 'all',
            activityType: 'all',
            productivity: 'all'
        };
        
        // Debounce para evitar aplicações muito frequentes
        let filterTimeout = null;
        
        // Função com debounce para aplicar filtros automaticamente
        function applyFiltersDebounced() {
            if (filterTimeout) {
                clearTimeout(filterTimeout);
            }
            filterTimeout = setTimeout(() => {
                applyFilters(false); // Não mostrar toast em aplicações automáticas
            }, 300); // 300ms de delay
        }

        // Dados do Django
        const chamados = [
            {% for chamado in chamados %}
            {
                nome_analista: "{{ chamado.nome_analista }}",
                tipo_atividade: "{{ chamado.tipo_atividade }}",
                total_horas: "{{ chamado.total_horas }}",
                produtiva: {% if chamado.produtiva %}true{% else %}false{% endif %},
                data: "{{ chamado.data|date:'Y-m-d' }}"
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];

        // Função para obter mapeamento dos analistas via AJAX
        let analistasMapping = {};
        
        async function carregarMapeamentoAnalistas() {
            try {
                const response = await fetch('/analistas/');
                const text = await response.text();
                
                // Extrair os IDs dos analistas do HTML da página
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const links = doc.querySelectorAll('a[href*="/ver_analista/"]');
                
                analistasMapping = {};
                links.forEach(link => {
                    const href = link.getAttribute('href');
                    const match = href.match(/\/ver_analista\/(\d+)\//);
                    if (match) {
                        const id = match[1];
                        const nomeElement = link.querySelector('.analista-name');
                        if (nomeElement) {
                            const nome = nomeElement.textContent.trim();
                            analistasMapping[nome] = parseInt(id);
                        }
                    }
                });
                
                console.log('🗺️ Mapeamento carregado via AJAX:', analistasMapping);
            } catch (error) {
                console.error('❌ Erro ao carregar mapeamento:', error);
                // Fallback para mapeamento básico
                analistasMapping = {
                    'Paulo Henrique': 1,
                    'João Cezar': 2,
                    'Ramon Farias': 3,
                    'Pedro Alexandre': 4,
                    'Adryson Costa': 5,
                    'Mateus Bezerra': 6,
                    'Guilherme Palmiere': 7,
                    'Miguel Campos': 8,
                    'Gean Cavalcante': 9
                };
            }
        }

        console.log('📊 Dados carregados:', chamados);
        console.log('📈 Quantidade de chamados:', chamados.length);

        // Função para obter nome formatado do analista
        function getNomeAnalista(analystKey) {
            const nomesAnalistas = {
                'Paulo_Henrique': 'Paulo Henrique',
                'Joao_Cezar': 'João Cezar',
                'Ramon_Farias': 'Ramon Farias',
                'Pedro_Alexandre': 'Pedro Alexandre',
                'Adryson_Costa': 'Adryson Costa',
                'Mateus_Bezerra': 'Mateus Bezerra',
                'Guilherme_Palmiere': 'Guilherme Palmiere',
                'Miguel_Campos': 'Miguel Campos',
                'Gean_Cavalcante': 'Gean Cavalcante'
            };
            return nomesAnalistas[analystKey] || analystKey;
        }

        // Função para converter tempo HH:MM:SS para minutos
        function timeToMinutes(timeStr) {
            if (!timeStr) return 0;
            const parts = timeStr.split(':');
            const hours = parseInt(parts[0]) || 0;
            const minutes = parseInt(parts[1]) || 0;
            const seconds = parseInt(parts[2]) || 0;
            return hours * 60 + minutes + (seconds / 60);
        }

        // Função para formatar minutos como "Xh Ym"
        function formatTime(totalMinutes) {
            const hours = Math.floor(totalMinutes / 60);
            const minutes = Math.round(totalMinutes % 60);
            if (hours === 0) {
                return `${minutes}m`;
            }
            return `${hours}h ${minutes}m`;
        }

        // FUNÇÕES DE FILTRO
        function applyFilters(showToast = false) {
            console.log('🔍 Aplicando filtros...', currentFilters);
            
            filteredChamados = chamados.filter(chamado => {
                // Filtro por período
                if (currentFilters.period !== 'custom') {
                    const days = parseInt(currentFilters.period);
                    const chamadoDate = new Date(chamado.data);
                    
                    if (days === 0) {
                        // Filtro "Hoje" - compara apenas a data (ignora hora e timezone)
                        const hoje = new Date();
                        const hojeSemHora = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
                        
                        // Parsear data do chamado corretamente (formato: YYYY-MM-DD)
                        const [ano, mes, dia] = chamado.data.split('-').map(Number);
                        const chamadoSemHora = new Date(ano, mes - 1, dia);
                        
                        if (chamadoSemHora.getTime() !== hojeSemHora.getTime()) return false;
                    } else {
                        // Filtros de período (7, 30, 90 dias)
                        const limitDate = new Date();
                        limitDate.setDate(limitDate.getDate() - days);
                        
                        if (chamadoDate < limitDate) return false;
                    }
                } else if (currentFilters.startDate && currentFilters.endDate) {
                    const startDate = new Date(currentFilters.startDate);
                    const endDate = new Date(currentFilters.endDate);
                    const chamadoDate = new Date(chamado.data);
                    
                    if (chamadoDate < startDate || chamadoDate > endDate) return false;
                }

                // Filtro por analista
                if (currentFilters.analysts !== 'all' && chamado.nome_analista !== currentFilters.analysts) {
                    return false;
                }

                // Filtro por tipo de atividade
                if (currentFilters.activityType !== 'all' && chamado.tipo_atividade !== currentFilters.activityType) {
                    return false;
                }

                // Filtro por produtividade
                if (currentFilters.productivity !== 'all') {
                    const isProductive = currentFilters.productivity === 'true';
                    if (chamado.produtiva !== isProductive) return false;
                }

                return true;
            });

            console.log('📊 Chamados filtrados:', filteredChamados.length);
            updateAllCharts();
            showSmartAlerts();
            
            // Toast de sucesso ao aplicar filtros (apenas quando solicitado)
            if (showToast) {
                const mensagemToast = currentFilters.analysts !== 'all' 
                    ? `${filteredChamados.length} chamado(s) encontrado(s) para ${getNomeAnalista(currentFilters.analysts)}`
                    : `${filteredChamados.length} chamado(s) encontrado(s)`;
                showToast('success', '🔍 Filtros Aplicados', mensagemToast);
            }
        }

        function clearFilters() {
            console.log('🔄 Limpando filtros...');
            
            // Resetar filtros
            currentFilters = {
                period: 30,
                startDate: null,
                endDate: null,
                analysts: 'all',
                activityType: 'all',
                productivity: 'all'
            };

            // Resetar interface
            document.getElementById('periodFilter').value = '30';
            document.getElementById('analystFilter').selectedIndex = 0;
            document.getElementById('activityFilter').value = 'all';
            document.getElementById('productivityFilter').value = 'all';
            document.getElementById('customDateGroup').style.display = 'none';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';

            // Aplicar filtros limpos
            filteredChamados = chamados;
            updateAllCharts();
            
            // Toast de sucesso ao limpar filtros
            showToast('info', '🔄 Filtros Limpos', 'Mostrando todos os chamados');
        }

        function updateAllCharts() {
            console.log('🎨 Atualizando todos os gráficos...');
            
            // Destruir gráficos existentes
            Chart.helpers.each(Chart.instances, function(instance) {
                instance.destroy();
            });

            // Recriar gráficos com dados filtrados
            createChart1();
            createChart2();
            createChart3();
            createChart4();
            updateStats();
        }

        // ALERTAS INTELIGENTES
        function showSmartAlerts() {
            // SEMPRE usar os dados filtrados, mesmo se for 0
            const totalChamados = filteredChamados.length;
            const chamadosProdutivos = filteredChamados.filter(c => c.produtiva).length;
            const taxaProdutividade = totalChamados > 0 ? (chamadosProdutivos / totalChamados) * 100 : 0;
            
            let alertas = [];

            // Alerta especial quando não há chamados
            if (totalChamados === 0) {
                alertas.push({
                    tipo: 'info',
                    titulo: '📭 Nenhum Chamado Encontrado',
                    mensagem: `Não há chamados registrados para os filtros selecionados.`
                });
            }

            // Alerta de produtividade baixa
            if (taxaProdutividade < 80 && totalChamados > 0) {
                alertas.push({
                    tipo: 'warning',
                    titulo: '⚠️ Produtividade Baixa',
                    mensagem: `Taxa de produtividade está em ${taxaProdutividade.toFixed(1)}%, abaixo dos 80% esperados.`
                });
            }

            // Alerta de poucos chamados
            if (totalChamados < 5 && totalChamados > 0 && currentFilters.period >= 7) {
                alertas.push({
                    tipo: 'info',
                    titulo: '📊 Poucos Chamados',
                    mensagem: `Apenas ${totalChamados} chamado(s) no período selecionado.`
                });
            }

            // Alerta de tempo médio alto
            const tempoTotal = filteredChamados.reduce((acc, c) => acc + timeToMinutes(c.total_horas), 0);
            const tempoMedio = totalChamados > 0 ? tempoTotal / totalChamados : 0;
            
            if (tempoMedio > 60) { // Mais de 1 hora
                alertas.push({
                    tipo: 'danger',
                    titulo: '⏰ Tempo Médio Alto',
                    mensagem: `Tempo médio de ${formatTime(tempoMedio)} por chamado está acima do esperado.`
                });
            }

            // Mostrar alertas
            displayAlerts(alertas);
        }

        function displayAlerts(alertas) {
            if (alertas.length === 0) return;

            const toastContainer = document.getElementById('toastContainer');
            
            alertas.forEach((alerta, index) => {
                // Delay para mostrar toasts sequencialmente
                setTimeout(() => {
                    showToast(alerta.tipo, alerta.titulo, alerta.mensagem);
                }, index * 200); // 200ms de delay entre cada toast
            });
        }

        // Função para criar e mostrar um toast
        function showToast(tipo, titulo, mensagem) {
            const toastContainer = document.getElementById('toastContainer');
            
            // Ícones por tipo
            const icones = {
                warning: '⚠️',
                danger: '⏰',
                info: '📊',
                success: '✅'
            };
            
            const toastDiv = document.createElement('div');
            toastDiv.className = `toast ${tipo}`;
            toastDiv.innerHTML = `
                <div class="toast-icon">${icones[tipo] || '📌'}</div>
                <div class="toast-content">
                    <div class="toast-title">${titulo}</div>
                    <div class="toast-message">${mensagem}</div>
                </div>
                <button class="toast-close" onclick="removeToast(this)">✕</button>
            `;
            
            toastContainer.appendChild(toastDiv);
            
            // Auto-remover após 4 segundos
            setTimeout(() => {
                removeToast(toastDiv);
            }, 4000);
            
            // Remover ao clicar no toast
            toastDiv.addEventListener('click', function(e) {
                if (!e.target.classList.contains('toast-close')) {
                    removeToast(this);
                }
            });
        }

        // Função para remover um toast
        function removeToast(element) {
            const toast = element.classList && element.classList.contains('toast') ? element : element.parentElement.parentElement;
            
            if (toast && toast.classList.contains('toast')) {
                toast.classList.add('hiding');
                setTimeout(() => {
                    toast.remove();
                }, 300); // Tempo da animação de saída
            }
        }

        // Função para criar URL com filtros aplicados
        function criarUrlComFiltros() {
            const params = new URLSearchParams();
            
            // Filtro de período - Mapear valores do dashboard para valores da página todos_chamados
            if (currentFilters.period === 'custom' && currentFilters.startDate && currentFilters.endDate) {
                params.set('startDate', currentFilters.startDate);
                params.set('endDate', currentFilters.endDate);
            } else if (currentFilters.period !== '30') { // 30 é o padrão
                // Mapear valores do dashboard para valores esperados pela página todos_chamados
                const periodoMapping = {
                    '0': 'today',    // Dashboard usa '0' para hoje, todos_chamados espera 'today'
                    '7': '7',        // Mesmo valor
                    '90': '90'       // Mesmo valor
                };
                const periodoValue = periodoMapping[currentFilters.period] || currentFilters.period;
                params.set('period', periodoValue);
            }
            
            // Nota: Os filtros de analista, tipo de atividade e produtividade são aplicados via JavaScript
            // na página todos_chamados, não via parâmetros URL do backend
            // Por isso não os incluímos nos parâmetros da URL
            
            const queryString = params.toString();
            const baseUrl = "{% url 'todos_chamados' %}";
            
            return queryString ? `${baseUrl}?${queryString}` : baseUrl;
        }

        // Função para redirecionar para todos os chamados com filtros
        function irParaTodosChamados() {
            const url = criarUrlComFiltros();
            console.log('🔗 Redirecionando para todos os chamados com filtros:', url);
            
            // Toast informativo
            const filtrosBackend = [];
            const filtrosFrontend = [];
            
            // Filtros que serão aplicados pelo backend (via URL)
            if (currentFilters.period !== '30') {
                const periodos = {
                    '0': 'Hoje',
                    '7': 'Últimos 7 dias',
                    '90': 'Últimos 3 meses',
                    'custom': 'Período personalizado'
                };
                filtrosBackend.push(`Período: ${periodos[currentFilters.period] || 'Personalizado'}`);
            }
            
            // Filtros que serão aplicados pelo frontend (JavaScript)
            if (currentFilters.analysts !== 'all') {
                filtrosFrontend.push(`Analista: ${getNomeAnalista(currentFilters.analysts)}`);
            }
            if (currentFilters.activityType !== 'all') {
                filtrosFrontend.push(`Tipo: ${currentFilters.activityType}`);
            }
            if (currentFilters.productivity !== 'all') {
                filtrosFrontend.push(`Produtividade: ${currentFilters.productivity === 'true' ? 'Produtivos' : 'Não-produtivos'}`);
            }
            
            let mensagem = '';
            if (filtrosBackend.length > 0 && filtrosFrontend.length > 0) {
                mensagem = `Filtros aplicados: ${filtrosBackend.join(', ')} + ${filtrosFrontend.join(', ')}`;
            } else if (filtrosBackend.length > 0) {
                mensagem = `Filtros aplicados: ${filtrosBackend.join(', ')}`;
            } else if (filtrosFrontend.length > 0) {
                mensagem = `Filtros aplicados: ${filtrosFrontend.join(', ')}`;
            } else {
                mensagem = 'Mostrando todos os chamados';
            }
                
            showToast('info', '📋 Redirecionando', mensagem);
            
            // Redirecionar após um pequeno delay para mostrar o toast
            setTimeout(() => {
                window.location.href = url;
            }, 800);
        }

        // Função para redirecionar para chamados produtivos
        function irParaChamadosProdutivos() {
            const params = new URLSearchParams();
            
            // Aplicar filtro de produtividade = true (chamados produtivos)
            params.set('productivity', 'true');
            
            // Manter outros filtros ativos do dashboard
            if (currentFilters.period !== '30') {
                const periodoMapping = {
                    '0': 'today',
                    '7': '7',
                    '90': '90'
                };
                const periodoValue = periodoMapping[currentFilters.period] || currentFilters.period;
                params.set('period', periodoValue);
            }
            
            if (currentFilters.analysts !== 'all') {
                params.set('analyst', currentFilters.analysts);
            }
            
            if (currentFilters.activityType !== 'all') {
                params.set('activityType', currentFilters.activityType);
            }
            
            const queryString = params.toString();
            const baseUrl = "{% url 'todos_chamados' %}";
            const url = queryString ? `${baseUrl}?${queryString}` : baseUrl;
            
            console.log('🔗 Redirecionando para chamados produtivos:', url);
            
            // Toast informativo
            const filtrosAtivos = ['Produtividade: Produtivos'];
            
            if (currentFilters.period !== '30') {
                const periodos = {
                    '0': 'Hoje',
                    '7': 'Últimos 7 dias',
                    '90': 'Últimos 3 meses',
                    'custom': 'Período personalizado'
                };
                filtrosAtivos.push(`Período: ${periodos[currentFilters.period] || 'Personalizado'}`);
            }
            
            if (currentFilters.analysts !== 'all') {
                filtrosAtivos.push(`Analista: ${getNomeAnalista(currentFilters.analysts)}`);
            }
            
            if (currentFilters.activityType !== 'all') {
                filtrosAtivos.push(`Tipo: ${currentFilters.activityType}`);
            }
            
            const mensagem = filtrosAtivos.length > 1 
                ? `Filtros aplicados: ${filtrosAtivos.join(', ')}`
                : 'Mostrando apenas chamados produtivos';
                
            showToast('success', '✅ Chamados Produtivos', mensagem);
            
            // Redirecionar após um pequeno delay para mostrar o toast
            setTimeout(() => {
                window.location.href = url;
            }, 800);
        }

        // ATUALIZAR CARDS
        function updateStats() {
            // SEMPRE usar os dados filtrados, mesmo se for 0
            const dataToUse = filteredChamados;
            const totalChamados = dataToUse.length;
            const chamadosProdutivos = dataToUse.filter(c => c.produtiva).length;
            const taxaProdutividade = totalChamados > 0 ? ((chamadosProdutivos / totalChamados) * 100).toFixed(1) : 0;
            const tempoTotal = dataToUse.reduce((acc, c) => acc + timeToMinutes(c.total_horas), 0);
            const tempoMedio = totalChamados > 0 ? tempoTotal / totalChamados : 0;

            console.log('📊 Estatísticas calculadas:', {
                totalChamados,
                chamadosProdutivos,
                taxaProdutividade,
                tempoMedio: formatTime(tempoMedio),
                dadosFiltrados: filteredChamados.length,
                dadosTotais: chamados.length
            });

            // Atualizar elementos
            document.getElementById('totalChamados').textContent = totalChamados;
            document.getElementById('tempoMedio').textContent = formatTime(tempoMedio);
            document.getElementById('taxaProdutividade').textContent = taxaProdutividade + '%';
        }

        // GRÁFICO 1: Distribuição por Tipo de Atividade (Doughnut)
        function createChart1() {
            console.log('🎨 Criando Gráfico 1...');
            
            // SEMPRE usar os dados filtrados, mesmo se for 0
            const dataToUse = filteredChamados;
            const tiposAtividade = {};
            dataToUse.forEach(c => {
                tiposAtividade[c.tipo_atividade] = (tiposAtividade[c.tipo_atividade] || 0) + 1;
            });

            const tiposLabels = Object.keys(tiposAtividade);
            const tiposValues = Object.values(tiposAtividade);
            const totalChamados = dataToUse.length;

            console.log('📊 Dados Gráfico 1:', { tiposAtividade, tiposLabels, tiposValues });

            const ctx = document.getElementById('chartTipoAtividade').getContext('2d');
            const chart1 = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: tiposLabels,
                    datasets: [{
                        data: tiposValues,
                        backgroundColor: [
                            '#F8C24A',
                            '#FFD666',
                            '#FFEB99',
                            '#FFF5CC',
                            '#C69A3A'
                        ],
                        borderColor: '#1a1a1a',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#fff',
                                padding: 15,
                                font: { size: 13, weight: '600' }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#F8C24A',
                            bodyColor: '#fff',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const percent = ((value / totalChamados) * 100).toFixed(1);
                                    return `${label}: ${value} (${percent}%)`;
                                }
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 20,
                            bottom: 20,
                            left: 20,
                            right: 20
                        }
                    },
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const tipoSelecionado = tiposLabels[index];
                            
                            // Redirecionar para todos os chamados com filtro aplicado
                            const url = `{% url 'todos_chamados' %}?activityType=${encodeURIComponent(tipoSelecionado)}`;
                            window.location.href = url;
                        }
                    }
                }
            });
            
            console.log('✅ Gráfico 1 criado com sucesso!');
        }

        // GRÁFICO 2: Chamados por Analista (Bar)
        function createChart2() {
            console.log('🎨 Criando Gráfico 2...');
            
            // SEMPRE usar os dados filtrados, mesmo se for 0
            const dataToUse = filteredChamados;
            
            let analistasLabels, analistasValues;
            
            // Se um analista específico foi selecionado, mostrar apenas ele
            if (currentFilters.analysts !== 'all') {
                analistasLabels = [getNomeAnalista(currentFilters.analysts)];
                const chamadosDoAnalista = dataToUse.filter(c => c.nome_analista === currentFilters.analysts).length;
                analistasValues = [chamadosDoAnalista];
                
                console.log('📊 Gráfico 2 - Analista específico:', currentFilters.analysts, chamadosDoAnalista);
            } else {
                // Lista de todos os analistas do sistema
                const todosAnalistas = [
                    'Paulo_Henrique', 'Joao_Cezar', 'Ramon_Farias',
                    'Pedro_Alexandre', 'Adryson_Costa', 'Mateus_Bezerra',
                    'Guilherme_Palmiere', 'Miguel_Campos', 'Gean_Cavalcante'
                ];
                
                const chamadosPorAnalista = {};
                dataToUse.forEach(c => {
                    chamadosPorAnalista[c.nome_analista] = (chamadosPorAnalista[c.nome_analista] || 0) + 1;
                });

                // Garantir que todos os analistas apareçam (mesmo com 0)
                analistasLabels = todosAnalistas.map(a => getNomeAnalista(a));
                analistasValues = todosAnalistas.map(analista => chamadosPorAnalista[analista] || 0);
                
                console.log('📊 Gráfico 2 - Todos analistas:', { chamadosPorAnalista, analistasLabels, analistasValues });
            }

            const ctx = document.getElementById('chartAnalista').getContext('2d');
            const chartAnalista = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: analistasLabels,
                    datasets: [{
                        data: analistasValues,
                        backgroundColor: '#F8C24A',
                        borderColor: '#C69A3A',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#F8C24A',
                            bodyColor: '#fff',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed.y} chamado(s)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            suggestedMax: Math.max(...analistasValues) + 1,
                            max: Math.max(...analistasValues) + 1,
                            ticks: { 
                                color: '#999', 
                                font: { size: 12 },
                                stepSize: 1
                            },
                            grid: { color: 'rgba(248, 194, 74, 0.1)' }
                        },
                        x: {
                            ticks: { 
                                color: '#999', 
                                font: { size: currentFilters.analysts !== 'all' ? 14 : 10 },
                                maxRotation: currentFilters.analysts !== 'all' ? 0 : 45
                            },
                            grid: { display: false }
                        }
                    },
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const nomeClicado = analistasLabels[index]; // Pegar o nome que foi clicado
                            
                            console.log('🖱️ Clique no analista - Nome:', nomeClicado, 'Index:', index);
                            console.log('🗺️ Mapeamento disponível:', analistasMapping);
                            
                            // Usar o mapeamento dinâmico do backend
                            const analistaId = analistasMapping[nomeClicado];
                            
                            console.log('🆔 ID do analista encontrado:', analistaId);
                            
                            if (analistaId) {
                                // Redirecionar diretamente para o relatório do analista
                                const url = `/ver_analista/${analistaId}/`;
                                console.log('🔗 Redirecionando para:', url);
                                window.location.href = url;
                            } else {
                                console.error('❌ ID não encontrado para o analista:', nomeClicado);
                                showToast('danger', '❌ Erro', `Analista "${nomeClicado}" não encontrado!`);
                            }
                        }
                    }
                }
            });
            
            console.log('✅ Gráfico 2 criado com sucesso!');
        }

        // GRÁFICO 3: Tempo Médio por Mês (Line)
        function createChart3() {
            console.log('🎨 Criando Gráfico 3...');
            
            // SEMPRE usar os dados filtrados, mesmo se for 0
            const dataToUse = filteredChamados;
            const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            const tempoPorMes = {};
            const chamadosPorMes = {};
            
            // Inicializar todos os meses com 0
            meses.forEach(mes => {
                tempoPorMes[mes] = 0;
                chamadosPorMes[mes] = 0;
            });
            
            // Calcular tempo total e quantidade de chamados por mês
            dataToUse.forEach(c => {
                const data = new Date(c.data);
                const mes = meses[data.getMonth()];
                tempoPorMes[mes] += timeToMinutes(c.total_horas);
                chamadosPorMes[mes] += 1;
            });

            // Calcular tempo MÉDIO por mês (divisão)
            const tempoMedioPorMes = meses.map(mes => {
                if (chamadosPorMes[mes] > 0) {
                    return tempoPorMes[mes] / chamadosPorMes[mes];
                } else {
                    return 0;
                }
            });

            // Calcular o valor máximo para ajustar o eixo Y
            const valorMaximo = Math.max(...tempoMedioPorMes);
            const suggestedMax = valorMaximo > 0 ? Math.ceil(valorMaximo * 1.2) : 60; // 20% a mais que o máximo

            console.log('📊 Dados Gráfico 3:', { 
                tempoPorMes, 
                chamadosPorMes, 
                tempoMedioPorMes, 
                valorMaximo, 
                suggestedMax 
            });

            const ctx = document.getElementById('chartTempoMes').getContext('2d');
            const chartTempoMes = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: meses,
                    datasets: [{
                        data: tempoMedioPorMes,
                        borderColor: '#F8C24A',
                        backgroundColor: 'rgba(248, 194, 74, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#F8C24A',
                        pointBorderColor: '#C69A3A',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#F8C24A',
                            bodyColor: '#fff',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const mes = context.label;
                                    const chamadosNoMes = chamadosPorMes[mes];
                                    const tempoMedio = formatTime(context.parsed.y);
                                    return `Tempo médio: ${tempoMedio} (${chamadosNoMes} chamado${chamadosNoMes !== 1 ? 's' : ''})`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            suggestedMax: suggestedMax,
                            max: suggestedMax,
                            ticks: { 
                                color: '#999', 
                                font: { size: 12 },
                                callback: function(value) {
                                    return formatTime(value);
                                },
                                stepSize: Math.ceil(suggestedMax / 5) // 5 divisões no eixo Y
                            },
                            grid: { color: 'rgba(248, 194, 74, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#999', font: { size: 12 } },
                            grid: { color: 'rgba(248, 194, 74, 0.1)' }
                        }
                    },
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const mesSelecionado = meses[index];
                            
                            // Redirecionar para a aba de analistas
                            const url = `{% url 'nomes_analistas' %}`;
                            window.location.href = url;
                        }
                    }
                }
            });
            
            console.log('✅ Gráfico 3 criado com sucesso!');
        }

        // GRÁFICO 4: Tempo Médio por Analista (Bar)
        function createChart4() {
            console.log('🎨 Criando Gráfico 4...');
            
            // SEMPRE usar os dados filtrados, mesmo se for 0
            const dataToUse = filteredChamados;
            
            let analistasLabels, tempoMedioValues;
            
            // Se um analista específico foi selecionado, mostrar apenas ele
            if (currentFilters.analysts !== 'all') {
                const analistaSelecionado = currentFilters.analysts;
                const chamadosDoAnalista = dataToUse.filter(c => c.nome_analista === analistaSelecionado);
                
                if (chamadosDoAnalista.length > 0) {
                    const tempoTotal = chamadosDoAnalista.reduce((acc, c) => acc + timeToMinutes(c.total_horas), 0);
                    const tempoMedio = tempoTotal / chamadosDoAnalista.length;
                    
                    analistasLabels = [getNomeAnalista(analistaSelecionado)];
                    tempoMedioValues = [tempoMedio];
                } else {
                    analistasLabels = [getNomeAnalista(analistaSelecionado)];
                    tempoMedioValues = [0];
                }
                
                console.log('📊 Gráfico 4 - Analista específico:', analistaSelecionado, tempoMedioValues);
            } else {
                // Lista de todos os analistas do sistema
                const todosAnalistas = [
                    'Paulo_Henrique', 'Joao_Cezar', 'Ramon_Farias',
                    'Pedro_Alexandre', 'Adryson_Costa', 'Mateus_Bezerra',
                    'Guilherme_Palmiere', 'Miguel_Campos', 'Gean_Cavalcante'
                ];
                
                const tempoPorAnalista = {};
                const chamadosPorAnalista = {};
                
                dataToUse.forEach(c => {
                    const tempo = timeToMinutes(c.total_horas);
                    tempoPorAnalista[c.nome_analista] = (tempoPorAnalista[c.nome_analista] || 0) + tempo;
                    chamadosPorAnalista[c.nome_analista] = (chamadosPorAnalista[c.nome_analista] || 0) + 1;
                });

                // Calcular tempo médio por analista (incluindo os com 0)
                const tempoMedioPorAnalista = {};
                todosAnalistas.forEach(analista => {
                    if (chamadosPorAnalista[analista]) {
                        tempoMedioPorAnalista[analista] = tempoPorAnalista[analista] / chamadosPorAnalista[analista];
                    } else {
                        tempoMedioPorAnalista[analista] = 0;
                    }
                });

                analistasLabels = todosAnalistas.map(a => getNomeAnalista(a));
                tempoMedioValues = todosAnalistas.map(analista => tempoMedioPorAnalista[analista] || 0);
                
                console.log('📊 Gráfico 4 - Todos analistas:', { tempoMedioPorAnalista, analistasLabels, tempoMedioValues });
            }

            const ctx = document.getElementById('chartTempoAnalista').getContext('2d');
            const chartTempoAnalista = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: analistasLabels,
                    datasets: [{
                        data: tempoMedioValues,
                        backgroundColor: '#F8C24A',
                        borderColor: '#C69A3A',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#F8C24A',
                            bodyColor: '#fff',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${formatTime(context.parsed.y)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            suggestedMax: Math.max(...tempoMedioValues) * 1.3,
                            max: Math.max(...tempoMedioValues) * 1.3,
                            ticks: { 
                                color: '#999', 
                                font: { size: 12 },
                                callback: function(value) {
                                    return formatTime(value);
                                },
                                stepSize: Math.ceil((Math.max(...tempoMedioValues) * 1.3) / 5)
                            },
                            grid: { color: 'rgba(248, 194, 74, 0.1)' }
                        },
                        x: {
                            ticks: { 
                                color: '#999', 
                                font: { size: currentFilters.analysts !== 'all' ? 14 : 10 },
                                maxRotation: currentFilters.analysts !== 'all' ? 0 : 45
                            },
                            grid: { display: false }
                        }
                    },
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const nomeClicado = analistasLabels[index]; // Pegar o nome que foi clicado
                            
                            console.log('🖱️ Clique no analista (Tempo Médio) - Nome:', nomeClicado, 'Index:', index);
                            console.log('🗺️ Mapeamento disponível:', analistasMapping);
                            
                            // Usar o mapeamento dinâmico do backend
                            const analistaId = analistasMapping[nomeClicado];
                            
                            console.log('🆔 ID do analista encontrado:', analistaId);
                            
                            if (analistaId) {
                                // Redirecionar diretamente para o relatório do analista
                                const url = `/ver_analista/${analistaId}/`;
                                console.log('🔗 Redirecionando para:', url);
                                window.location.href = url;
                            } else {
                                console.error('❌ ID não encontrado para o analista:', nomeClicado);
                                showToast('danger', '❌ Erro', `Analista "${nomeClicado}" não encontrado!`);
                            }
                        }
                    }
                }
            });
            
            console.log('✅ Gráfico 4 criado com sucesso!');
        }


        // EVENT LISTENERS PARA FILTROS
        function setupEventListeners() {
            // Filtro de período - Aplicar automaticamente
            document.getElementById('periodFilter').addEventListener('change', function() {
                const value = this.value;
                currentFilters.period = value;
                
                if (value === 'custom') {
                    document.getElementById('customDateGroup').style.display = 'block';
                } else {
                    document.getElementById('customDateGroup').style.display = 'none';
                }
                
                // Aplicar filtros automaticamente com debounce
                applyFiltersDebounced();
            });

            // Date pickers - Aplicar automaticamente quando ambos estiverem preenchidos
            document.getElementById('startDate').addEventListener('change', function() {
                currentFilters.startDate = this.value;
                
                // Aplicar apenas se ambos os campos estiverem preenchidos
                const endDate = document.getElementById('endDate').value;
                if (this.value && endDate) {
                    applyFiltersDebounced();
                }
            });

            document.getElementById('endDate').addEventListener('change', function() {
                currentFilters.endDate = this.value;
                
                // Aplicar apenas se ambos os campos estiverem preenchidos
                const startDate = document.getElementById('startDate').value;
                if (this.value && startDate) {
                    applyFiltersDebounced();
                }
            });

            // Filtro de analistas - Aplicar automaticamente
            document.getElementById('analystFilter').addEventListener('change', function() {
                currentFilters.analysts = this.value;
                applyFiltersDebounced();
            });

            // Filtro de tipo de atividade - Aplicar automaticamente
            document.getElementById('activityFilter').addEventListener('change', function() {
                currentFilters.activityType = this.value;
                applyFiltersDebounced();
            });

            // Filtro de produtividade - Aplicar automaticamente
            document.getElementById('productivityFilter').addEventListener('change', function() {
                currentFilters.productivity = this.value;
                applyFiltersDebounced();
            });

            // Botões
            document.getElementById('applyFilters').addEventListener('click', function() {
                applyFilters(true); // Mostrar toast quando clicado manualmente
            });
            document.getElementById('clearFilters').addEventListener('click', clearFilters);
            
            // Card de Total de Chamados (clique para ir para todos os chamados)
            document.getElementById('totalChamadosCard').addEventListener('click', irParaTodosChamados);
            
            // Card de Taxa de Produtividade (clique para ir para chamados produtivos)
            document.getElementById('taxaProdutividadeCard').addEventListener('click', irParaChamadosProdutivos);
        }

        // INICIALIZAR TUDO
        async function initDashboard() {
            console.log('🚀 Inicializando dashboard...');
            
            // Carregar mapeamento dos analistas primeiro
            await carregarMapeamentoAnalistas();
            
            if (chamados.length === 0) {
                console.log('⚠️ Nenhum chamado encontrado');
                document.querySelector('.charts-grid').innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 60px; color: #F8C24A; font-size: 18px;">
                        <h3>📊 Nenhum Dado Disponível</h3>
                        <p style="color: #999; margin-top: 10px;">Registre alguns chamados para ver os gráficos e estatísticas.</p>
                        <a href="/cadastrar_chamado/" style="display: inline-block; margin-top: 20px; padding: 12px 24px; background: linear-gradient(135deg, #F8C24A 0%, #C69A3A 100%); color: #0a0a0a; text-decoration: none; border-radius: 8px; font-weight: 600;">
                            ➕ Registrar Primeiro Chamado
                        </a>
                    </div>
                `;
                return;
            }

            // Atualizar estatísticas
            updateStats();

            // Configurar event listeners
            setupEventListeners();

            // Inicializar dados filtrados
            filteredChamados = chamados;

            // Criar gráficos
            try {
                createChart1();
                createChart2();
                createChart3();
                createChart4();
                console.log('🎉 TODOS OS GRÁFICOS CRIADOS COM SUCESSO!');
                
                // Toast de boas-vindas
                setTimeout(() => {
                    showToast('success', '✨ Dashboard Carregado', 'Seus dados foram carregados com sucesso!');
                }, 500);
            } catch (error) {
                console.error('❌ Erro ao criar gráficos:', error);
            }
        }

        // Aguardar carregamento da página
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📄 DOM carregado, iniciando dashboard...');
            initDashboard();
        });

        // Fallback se DOM já estiver carregado
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initDashboard);
        } else {
            initDashboard();
        }
    </script>
</body>
</html>